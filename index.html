<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Quran Recitation System</title>
    <!-- [Previous CSS remains exactly the same] -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* [All previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML remains exactly the same until the script section] -->
    <script>
        class PersonalQuranAI {
            constructor() {
                this.recognition = null;
                this.mediaRecorder = null;
                this.isListening = false;
                this.isTraining = false;
                this.currentWordIndex = 0;
                this.currentSurahNumber = 1;
                this.currentVerseNumber = 1;
                this.totalWords = 0;
                this.correctWords = 0;
                this.synthesizer = window.speechSynthesis;
                this.hasDetectedPosition = false;
                this.quranDatabase = null;
                this.isDatabaseLoaded = false;
                this.personalVoiceData = {};
                this.audioContext = null;
                this.analyser = null;
                this.visualizationData = null;
                this.visualizationRunning = false;
                this.currentRenderStart = 1;
                this.currentRenderEnd = 5;
                
                this.initializeSystem();
                this.setupEventListeners();
                this.loadPersonalVoiceData();
                this.autoLoadQuranDatabase();
                this.initializeVisualization();
            }

            initializeSystem() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError("Speech recognition not supported. Please use Chrome, Edge, or Safari.");
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                // Enhanced configuration for Quranic Arabic with Pakistani accent support
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = document.getElementById('languageSelect').value;
                this.recognition.maxAlternatives = 5;
                
                // Enhanced acoustic model settings
                if (this.recognition.audioTrackSettings) {
                    this.recognition.audioTrackSettings = {
                        noiseSuppression: true,
                        echoCancellation: true,
                        autoGainControl: true,
                        sampleRate: 48000,
                        channelCount: 1
                    };
                }
                
                this.setupRecognitionHandlers();
            }

            // [Previous visualization methods remain the same]

            async autoLoadQuranDatabase() {
                // Updated with reliable Quran text sources
                const sources = [
                    'https://raw.githubusercontent.com/risan/quran-json/master/data/quran-simple-clean.json',
                    'https://cdn.jsdelivr.net/gh/fawazahmed0/quran-api@1/editions/ara-quransimple.txt'
                ];

                this.updateDatabaseStatus("ğŸ“š Auto-loading Quran database...", "loading");
                
                for (const source of sources) {
                    try {
                        const response = await fetch(source);
                        
                        if (response.ok) {
                            const data = await (source.endsWith('.json') ? response.json() : response.text());
                            
                            if (source.endsWith('.json')) {
                                this.parseJsonQuranDatabase(data);
                            } else {
                                this.parseCompleteQuranDatabase(data);
                            }
                            
                            this.renderQuranDisplay();
                            this.enableSystem();
                            this.updateDatabaseStatus(`âœ… Database loaded from ${new URL(source).hostname}`, "success");
                            return;
                        }
                    } catch (error) {
                        console.log(`Failed to load from ${source}:`, error);
                        continue;
                    }
                }
                
                this.updateDatabaseStatus("ğŸ“¤ Could not auto-load. Please upload manually.", "error");
            }

            parseJsonQuranDatabase(data) {
                this.quranDatabase = {};
                
                data.forEach(surah => {
                    this.quranDatabase[surah.number] = {
                        name: surah.name,
                        verses: []
                    };
                    
                    surah.verses.forEach(verse => {
                        const words = this.parseWordsFromVerse(verse.text);
                        this.quranDatabase[surah.number].verses[verse.number - 1] = words;
                    });
                });
                
                this.isDatabaseLoaded = true;
            }

            // [Previous parseCompleteQuranDatabase method remains the same]

            setupRecognitionHandlers() {
                this.recognition.onstart = () => {
                    this.updateStatus("ğŸš€ Listening for continuous recitation...");
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('startBtn').classList.add('recording');
                    
                    if (this.audioContext && navigator.mediaDevices) {
                        navigator.mediaDevices.getUserMedia({ 
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                sampleRate: 48000
                            }
                        })
                        .then(stream => {
                            const source = this.audioContext.createMediaStreamSource(stream);
                            source.connect(this.analyser);
                        })
                        .catch(error => {
                            console.log("Visualization audio error:", error);
                        });
                    }
                };

                this.recognition.onend = () => {
                    if (this.isListening) {
                        setTimeout(() => {
                            if (this.isListening) {
                                try {
                                    this.recognition.start();
                                } catch (error) {
                                    setTimeout(() => {
                                        if (this.isListening) {
                                            this.recognition.start();
                                        }
                                    }, 100);
                                }
                            }
                        }, 10);
                    } else {
                        this.updateStatus("â¹ï¸ Stopped listening");
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('startBtn').classList.remove('recording');
                        this.visualizationRunning = false;
                    }
                };

                this.recognition.onresult = (event) => {
                    this.processRecognitionResult(event);
                };

                this.recognition.onerror = (event) => {
                    this.handleRecognitionError(event);
                };
            }

            processRecognitionResult(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                let confidenceSum = 0;
                let resultCount = 0;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    confidenceSum += result[0].confidence || 0.7;
                    resultCount++;
                    
                    if (result.isFinal) {
                        finalTranscript += transcript;
                        this.processSpokenWords(transcript, (confidenceSum / resultCount));
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (interimTranscript) {
                    document.getElementById('lastRecognized').textContent = `ğŸ”„ ${interimTranscript}`;
                    document.getElementById('lastRecognized').style.color = '#666';
                }

                if (finalTranscript) {
                    document.getElementById('lastRecognized').textContent = finalTranscript;
                    document.getElementById('lastRecognized').style.color = '#333';
                }
            }

            processSpokenWords(spokenText, confidence) {
                // Enhanced preprocessing for Pakistani recitation
                const normalizedText = this.normalizePakistaniRecitation(spokenText);
                const words = normalizedText.trim().split(/\s+/);
                
                if (!this.hasDetectedPosition) {
                    if (words.length >= 2) {
                        const detectedPosition = this.detectStartingPosition(words);
                        if (detectedPosition) {
                            this.jumpToDetectedPosition(detectedPosition);
                            this.hasDetectedPosition = true;
                            this.updateStatus(`âœ… Auto-detected: ${detectedPosition.surahName}, Verse ${detectedPosition.verse} (${confidence.toFixed(1)}% confidence)`);
                            this.showDetectionSuccess(detectedPosition);
                            return;
                        }
                    }
                    this.updateStatus(`ğŸ” Listening... (${words.length} words heard, ${(confidence * 100).toFixed(0)}% confidence)`);
                    return;
                }
                
                for (let word of words) {
                    this.analyzeSpokenWord(word, confidence);
                }
                
                this.updateAccuracy();
                this.updateStatus(`ğŸ¤ Listening (${(confidence * 100).toFixed(0)}% confidence)`);
            }

            normalizePakistaniRecitation(text) {
                // Normalize common Pakistani pronunciation variations
                return text
                    .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                    .replace(/Ø©/g, 'Ù‡')
                    .replace(/Ù‰/g, 'ÙŠ')
                    .replace(/[Ø¤Ø¦]/g, 'Ø¡')
                    .replace(/Ø«/g, 'Ø³')
                    .replace(/Ø°/g, 'Ø²')
                    .replace(/Øµ/g, 'Ø³')
                    .replace(/Ø¶/g, 'Ø¯')
                    .replace(/Ø¸/g, 'Ø²')
                    .replace(/Ù‚/g, 'Ùƒ');
            }

            analyzeSpokenWord(spokenWord, confidence) {
                const expectedWord = this.getCurrentExpectedWord();
                if (!expectedWord) return;

                // Enhanced similarity calculation with confidence weighting
                const similarity = this.calculateEnhancedSimilarity(spokenWord, expectedWord) * confidence;
                
                if (similarity >= 75) { // Lowered threshold for Pakistani accents
                    this.markWordCorrect();
                    this.moveToNextWord();
                } else {
                    this.markWordIncorrect();
                    const errorType = this.determineErrorType(spokenWord, expectedWord);
                    this.provideTargetedFeedback(spokenWord, expectedWord, errorType);
                    this.moveToNextWord();
                }
            }

            calculateEnhancedSimilarity(spoken, expected) {
                // Multi-factor weighted similarity calculation
                const weights = {
                    exact: 0.4,
                    phonetic: 0.5,
                    contextual: 0.1
                };
                
                const exactMatch = this.calculateWordSimilarity(spoken, expected);
                const phoneticMatch = this.calculatePhoneticSimilarity(spoken, expected);
                const contextualMatch = this.checkContextualFit(spoken);
                
                return (exactMatch * weights.exact) + 
                       (phoneticMatch * weights.phonetic) + 
                       (contextualMatch * weights.contextual);
            }

            // [Rest of the methods remain the same as in your original code]
            
            // Only change the language selection event listener to reinitialize recognition
            setupEventListeners() {
                // [Previous event listeners remain the same]
                
                document.getElementById('languageSelect').addEventListener('change', (e) => {
                    if (this.recognition) {
                        this.recognition.lang = e.target.value;
                        // Reinitialize recognition with new language
                        if (this.isListening) {
                            this.stopListening();
                            setTimeout(() => this.startListening(), 100);
                        }
                    }
                });
            }
        }

        // Initialize the system
        document.addEventListener('DOMContentLoaded', () => {
            const personalQuranAI = new PersonalQuranAI();
            
            console.log("ğŸ¤ Enhanced AI Quran System Initialized");
            console.log("ğŸ‡µğŸ‡° Pakistani accent optimization: ACTIVE");
            console.log("ğŸ” Improved voice recognition: ENABLED");
            console.log("ğŸŒ Multiple database sources: CONFIGURED");
        });
    </script>
</body>
</html>
