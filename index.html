<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quran Recitation System</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,0.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.1)}.header{text-align:center;margin-bottom:30px}.header h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}.control-group{background:#f8f9fa;padding:20px;border-radius:15px;border:2px solid #e9ecef}.btn{background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:12px 25px;border-radius:25px;cursor:pointer;font-size:1em;margin:5px;min-width:150px}.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}.btn:disabled{background:#bdc3c7;cursor:not-allowed}.btn.recording{background:linear-gradient(45deg,#e74c3c,#c0392b);animation:pulse 1.5s infinite}@keyframes pulse{0%{opacity:1}50%{opacity:0.7}100%{opacity:1}}select{width:100%;padding:10px;border:2px solid #ddd;border-radius:10px;margin:10px 0}.status{background:#f8f9fa;padding:20px;border-radius:15px;margin:20px 0}.quran-display{background:#fff;border:2px solid #e9ecef;border-radius:15px;padding:25px;margin:20px 0;min-height:400px;font-family:'Amiri','Times New Roman',serif;line-height:2.5;font-size:1.4em;text-align:right;direction:rtl;max-height:500px;overflow-y:auto}.verse{margin:15px 0;padding:15px;border-radius:10px;border:2px solid #f0f0f0}.verse.current{background:rgba(102,126,234,0.1);border-color:#667eea}.word{display:inline-block;margin:0 5px;padding:5px 10px;border-radius:8px;transition:all 0.3s ease}.word.correct{background:rgba(46,204,113,0.2)}.word.incorrect{background:rgba(231,76,60,0.2)}.word.current{background:rgba(241,196,15,0.3);transform:scale(1.05)}.database-status{background:#d4edda;border:2px solid #c3e6cb;color:#155724;padding:15px;border-radius:10px;margin:15px 0;text-align:center}.database-status.error{background:#f8d7da;border-color:#f5c6cb;color:#721c24}.error-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#e74c3c;color:white;padding:20px;border-radius:15px;z-index:1000;display:none;max-width:500px;text-align:center}.mistakes-panel{background:#f8f9fa;padding:20px;border-radius:15px;margin-top:20px}.mistake-item{padding:10px;border-bottom:1px solid #eee}.history-panel{background:#f8f9fa;padding:20px;border-radius:15px;margin-top:20px;display:none}.history-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}.history-item:hover{background:#f0f0f0}.tab-container{display:flex;margin-bottom:15px}.tab{padding:10px 20px;cursor:pointer;border-bottom:3px solid transparent}.tab.active{border-bottom:3px solid #667eea;font-weight:bold}.file-input{display:none}.upload-section{display:none;margin-top:15px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Quran Recitation System</h1>
            <p>Pakistani Accent Optimized - Continuous Listening</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Audio Control</h3>
                <button id="startBtn" class="btn" disabled>Start Listening</button>
                <button id="stopBtn" class="btn" disabled>Stop Listening</button>
                <select id="languageSelect">
                    <option value="ur-PK">Urdu/Pakistani Arabic</option>
                    <option value="ar-SA">Standard Arabic</option>
                </select>
            </div>

            <div class="control-group">
                <h3>Mistake Detection</h3>
                <select id="errorFocusType">
                    <option value="pronunciation">Pronunciation Mistakes</option>
                    <option value="words">Word Mistakes</option>
                </select>
            </div>
        </div>

        <div id="databaseStatus" class="database-status">
            Loading Quran database from GitHub...
        </div>

        <div id="uploadSection" class="upload-section">
            <h3>Manual Quran Text Upload</h3>
            <input type="file" id="quranFileInput" accept=".txt">
            <button id="loadQuranBtn" class="btn">Upload Quran Text</button>
        </div>

        <div class="status">
            <div id="status">Initializing system...</div>
            <div id="position">Waiting for recitation...</div>
        </div>

        <div class="quran-display" id="quranDisplay">
            Loading Quran text...
        </div>

        <div class="tab-container">
            <div class="tab active" id="mistakesTab">Current Mistakes</div>
            <div class="tab" id="historyTab">History</div>
        </div>

        <div class="mistakes-panel" id="mistakesPanel">
            <h3>Mistakes in Current Session</h3>
            <div id="mistakesList"></div>
        </div>

        <div class="history-panel" id="historyPanel">
            <h3>Recitation History</h3>
            <div id="historyList"></div>
        </div>

        <div class="error-popup" id="errorPopup">
            <div id="errorMessage"></div>
        </div>
    </div>

    <script>
        class QuranRecitationSystem {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.currentSurah = 1;
                this.currentVerse = 1;
                this.currentWord = 0;
                this.quranDatabase = {};
                this.currentMistakes = [];
                this.recitationHistory = [];
                this.sessionStartTime = null;
                this.positionDetected = false;
                this.initialize();
            }

            async initialize() {
                this.setupEventListeners();
                await this.loadQuranDatabase();
                this.setupSpeechRecognition();
            }

            setupEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.startListening());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopListening());
                document.getElementById('languageSelect').addEventListener('change', (e) => {
                    if (this.recognition) this.recognition.lang = e.target.value;
                });
                document.getElementById('mistakesTab').addEventListener('click', () => this.showMistakesPanel());
                document.getElementById('historyTab').addEventListener('click', () => this.showHistoryPanel());
                document.getElementById('loadQuranBtn').addEventListener('click', () => this.handleManualUpload());
            }

            showMistakesPanel() {
                document.getElementById('mistakesPanel').style.display = 'block';
                document.getElementById('historyPanel').style.display = 'none';
                document.getElementById('mistakesTab').classList.add('active');
                document.getElementById('historyTab').classList.remove('active');
            }

            showHistoryPanel() {
                document.getElementById('mistakesPanel').style.display = 'none';
                document.getElementById('historyPanel').style.display = 'block';
                document.getElementById('mistakesTab').classList.remove('active');
                document.getElementById('historyTab').classList.add('active');
            }

            async loadQuranDatabase() {
                const githubUrl = 'https://raw.githubusercontent.com/msaym22/quran-resitation/main/quran-simple.txt';
                try {
                    const response = await fetch(githubUrl);
                    if (!response.ok) throw new Error("GitHub load failed");
                    const text = await response.text();
                    if (!text || text.trim().length < 1000) throw new Error("Invalid file content");
                    this.parseQuranText(text);
                    this.renderQuranText();
                    document.getElementById('databaseStatus').textContent = "Quran database loaded from GitHub";
                    document.getElementById('startBtn').disabled = false;
                } catch (error) {
                    document.getElementById('databaseStatus').textContent = "Failed to load from GitHub. Please upload manually.";
                    document.getElementById('databaseStatus').classList.add('error');
                    document.getElementById('uploadSection').style.display = 'block';
                }
            }

            async handleManualUpload() {
                const fileInput = document.getElementById('quranFileInput');
                const file = fileInput.files[0];
                if (!file) {
                    this.showError("Please select a Quran text file first");
                    return;
                }
                try {
                    document.getElementById('databaseStatus').textContent = "Loading Quran text...";
                    document.getElementById('databaseStatus').classList.remove('error');
                    const text = await this.readFileAsText(file);
                    this.parseQuranText(text);
                    this.renderQuranText();
                    document.getElementById('databaseStatus').textContent = "Quran database loaded successfully";
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('uploadSection').style.display = 'none';
                } catch (error) {
                    document.getElementById('databaseStatus').textContent = "Error loading file: " + error.message;
                    document.getElementById('databaseStatus').classList.add('error');
                }
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => resolve(event.target.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsText(file);
                });
            }

            parseQuranText(text) {
                const lines = text.split('\n');
                let currentSurah = 1;
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed) continue;
                    const words = trimmed.split(/\s+/);
                    const verseNumber = parseInt(words.pop());
                    if (isNaN(verseNumber)) {
                        currentSurah++;
                        continue;
                    }
                    if (!this.quranDatabase[currentSurah]) {
                        this.quranDatabase[currentSurah] = {
                            name: this.getSurahName(currentSurah),
                            verses: []
                        };
                    }
                    this.quranDatabase[currentSurah].verses[verseNumber - 1] = words;
                }
            }

            getSurahName(number) {
                const names = {
                    1: "الفاتحة", 2: "البقرة", 3: "آل عمران", 4: "النساء", 5: "المائدة",
                    6: "الأنعام", 7: "الأعراف", 8: "الأنفال", 9: "التوبة", 10: "يونس",
                    11: "هود", 12: "يوسف", 13: "الرعد", 14: "إبراهيم", 15: "الحجر",
                    16: "النحل", 17: "الإسراء", 18: "الكهف", 19: "مريم", 20: "طه",
                    21: "الأنبياء", 22: "الحج", 23: "المؤمنون", 24: "النور", 25: "الفرقان",
                    26: "الشعراء", 27: "النمل", 28: "القصص", 29: "العنكبوت", 30: "الروم",
                    31: "لقمان", 32: "السجدة", 33: "الأحزاب", 34: "سبأ", 35: "فاطر",
                    36: "يس", 37: "الصافات", 38: "ص", 39: "الزمر", 40: "غافر",
                    41: "فصلت", 42: "الشورى", 43: "الزخرف", 44: "الدخان", 45: "الجاثية",
                    46: "الأحقاف", 47: "محمد", 48: "الفتح", 49: "الحجرات", 50: "ق",
                    51: "الذاريات", 52: "الطور", 53: "النجم", 54: "القمر", 55: "الرحمن",
                    56: "الواقعة", 57: "الحديد", 58: "المجادلة", 59: "الحشر", 60: "الممتحنة",
                    61: "الصف", 62: "الجمعة", 63: "المنافقون", 64: "التغابن", 65: "الطلاق",
                    66: "التحريم", 67: "الملك", 68: "القلم", 69: "الحاقة", 70: "المعارج",
                    71: "نوح", 72: "الجن", 73: "المزمل", 74: "المدثر", 75: "القيامة",
                    76: "الإنسان", 77: "المرسلات", 78: "النبأ", 79: "النازعات", 80: "عبس",
                    81: "التكوير", 82: "الانفطار", 83: "المطففين", 84: "الانشقاق", 85: "البروج",
                    86: "الطارق", 87: "الأعلى", 88: "الغاشية", 89: "الفجر", 90: "البلد",
                    91: "الشمس", 92: "الليل", 93: "الضحى", 94: "الشرح", 95: "التين",
                    96: "العلق", 97: "القدر", 98: "البينة", 99: "الزلزلة", 100: "العاديات",
                    101: "القارعة", 102: "التكاثر", 103: "العصر", 104: "الهمزة", 105: "الفيل",
                    106: "قريش", 107: "الماعون", 108: "الكوثر", 109: "الكافرون", 110: "النصر",
                    111: "المسد", 112: "الإخلاص", 113: "الفلق", 114: "الناس"
                };
                return names[number] || `Surah ${number}`;
            }

            renderQuranText() {
                const display = document.getElementById('quranDisplay');
                let html = '';
                for (const [surahNum, surah] of Object.entries(this.quranDatabase)) {
                    html += `<div style="text-align:center;background:#667eea;color:white;padding:10px;border-radius:10px;margin:15px 0">
                        ${surah.name} (${surahNum})</div>`;
                    surah.verses.forEach((verse, index) => {
                        if (!verse) return;
                        const verseClass = (parseInt(surahNum) === 1 && index === 0) ? 'verse current' : 'verse';
                        html += `<div class="${verseClass}" data-surah="${surahNum}" data-verse="${index + 1}">`;
                        verse.forEach((word, wordIndex) => {
                            const wordClass = (parseInt(surahNum) === 1 && index === 0 && wordIndex === 0) ? 'word current' : 'word';
                            html += `<span class="${wordClass}" data-word="${word}" data-surah="${surahNum}" data-verse="${index + 1}" data-index="${wordIndex}">${word}</span>`;
                        });
                        html += `<span style="background:#667eea;color:white;border-radius:50%;width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;margin-right:10px;">
                            ${index + 1}</span></div>`;
                    });
                }
                display.innerHTML = html;
            }

            setupSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    this.showError("Speech recognition not supported in this browser");
                    return;
                }
                this.recognition = new webkitSpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'ar-SA';
                this.recognition.maxAlternatives = 3;
                this.recognition.onstart = () => {
                    this.updateStatus("Listening...");
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('startBtn').classList.add('recording');
                    this.sessionStartTime = new Date();
                    this.positionDetected = false;
                };
                this.recognition.onend = () => {
                    if (this.isListening) this.recognition.start();
                };
                this.recognition.onresult = (event) => {
                    let final = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) final += event.results[i][0].transcript;
                    }
                    if (final) this.processRecitation(final);
                };
            }

            processRecitation(text) {
                const words = text.trim().split(/\s+/);
                
                if (!this.positionDetected) {
                    const detected = this.detectPosition(words);
                    if (detected) {
                        this.currentSurah = detected.surah;
                        this.currentVerse = detected.verse;
                        this.currentWord = detected.wordIndex;
                        this.positionDetected = true;
                        this.updatePosition();
                        this.highlightCurrentWord();
                        this.showError(`Position detected: ${this.quranDatabase[this.currentSurah].name} ${this.currentVerse}:${this.currentWord + 1}`);
                    } else {
                        this.updateStatus("Listening... Please recite at least 3 consecutive words from the Quran");
                    }
                    return;
                }

                const currentVerse = this.quranDatabase[this.currentSurah].verses[this.currentVerse - 1];
                const expectedWord = currentVerse[this.currentWord];
                
                if (this.compareWords(words[0], expectedWord)) {
                    this.markWordCorrect();
                } else {
                    this.markWordIncorrect(words[0], expectedWord);
                }
                
                this.moveToNextWord();
            }

            compareWords(spoken, expected) {
                const cleanSpoken = spoken.replace(/[\u064B-\u065F]/g, '');
                const cleanExpected = expected.replace(/[\u064B-\u065F]/g, '');
                return cleanSpoken === cleanExpected;
            }

            markWordCorrect() {
                const wordElement = this.getCurrentWordElement();
                if (wordElement) wordElement.classList.add('correct');
            }

            markWordIncorrect(spoken, expected) {
                const wordElement = this.getCurrentWordElement();
                if (wordElement) {
                    wordElement.classList.add('incorrect');
                    this.recordMistake(spoken, expected);
                    this.speakContextWords();
                }
            }

            speakContextWords() {
                const verse = this.quranDatabase[this.currentSurah].verses[this.currentVerse - 1];
                const start = Math.max(0, this.currentWord - 2);
                const end = Math.min(verse.length - 1, this.currentWord + 2);
                const contextWords = verse.slice(start, end + 1).join(' ');
                
                const utterance = new SpeechSynthesisUtterance();
                utterance.text = contextWords;
                utterance.lang = 'ar-SA';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }

            recordMistake(spoken, expected) {
                const mistake = {
                    timestamp: new Date(),
                    spoken: spoken,
                    expected: expected,
                    surah: this.currentSurah,
                    verse: this.currentVerse,
                    wordIndex: this.currentWord,
                    surahName: this.quranDatabase[this.currentSurah].name
                };
                this.currentMistakes.push(mistake);
                this.updateMistakesList();
            }

            updateMistakesList() {
                const list = document.getElementById('mistakesList');
                list.innerHTML = '';
                this.currentMistakes.slice().reverse().forEach(mistake => {
                    const item = document.createElement('div');
                    item.className = 'mistake-item';
                    item.innerHTML = `<strong>${mistake.surahName} ${mistake.verse}:${mistake.wordIndex + 1}</strong><br>
                        You said: "${mistake.spoken}"<br>Expected: "${mistake.expected}"`;
                    list.appendChild(item);
                });
            }

            moveToNextWord() {
                const currentVerse = this.quranDatabase[this.currentSurah].verses[this.currentVerse - 1];
                if (this.currentWord < currentVerse.length - 1) {
                    this.currentWord++;
                } else {
                    this.currentWord = 0;
                    this.currentVerse++;
                    if (this.currentVerse > this.quranDatabase[this.currentSurah].verses.length) {
                        this.currentSurah++;
                        this.currentVerse = 1;
                    }
                }
                this.updatePosition();
                this.highlightCurrentWord();
            }

            highlightCurrentWord() {
                document.querySelectorAll('.word.current').forEach(el => el.classList.remove('current'));
                const wordElement = this.getCurrentWordElement();
                if (wordElement) {
                    wordElement.classList.add('current');
                    wordElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            getCurrentWordElement() {
                return document.querySelector(`.word[data-surah="${this.currentSurah}"][data-verse="${this.currentVerse}"][data-index="${this.currentWord}"]`);
            }

            detectPosition(words) {
                if (words.length < 3) return null;
                
                for (const [surahNum, surah] of Object.entries(this.quranDatabase)) {
                    for (let verseNum = 0; verseNum < surah.verses.length; verseNum++) {
                        const verse = surah.verses[verseNum];
                        if (!verse) continue;
                        
                        for (let i = 0; i <= verse.length - words.length; i++) {
                            let matchCount = 0;
                            for (let j = 0; j < words.length; j++) {
                                if (this.compareWords(words[j], verse[i + j])) {
                                    matchCount++;
                                } else {
                                    break;
                                }
                            }
                            
                            if (matchCount >= 3) {
                                return {
                                    surah: parseInt(surahNum),
                                    verse: verseNum + 1,
                                    wordIndex: i
                                };
                            }
                        }
                    }
                }
                return null;
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }

            updatePosition() {
                const surahName = this.quranDatabase[this.currentSurah].name;
                document.getElementById('position').textContent = `${surahName} (${this.currentSurah}), Verse ${this.currentVerse}`;
            }

            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorPopup').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorPopup').style.display = 'none';
                }, 3000);
            }

            startListening() {
                if (this.recognition) {
                    this.isListening = true;
                    this.currentMistakes = [];
                    this.updateMistakesList();
                    this.recognition.start();
                }
            }

            stopListening() {
                this.isListening = false;
                this.recognition.stop();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('startBtn').classList.remove('recording');
                this.updateStatus("Ready");
                this.saveSession();
            }

            saveSession() {
                if (this.currentMistakes.length === 0) return;
                const session = {
                    id: Date.now(),
                    date: new Date(),
                    duration: (new Date() - this.sessionStartTime) / 1000,
                    mistakes: [...this.currentMistakes],
                    surah: this.currentSurah,
                    verse: this.currentVerse
                };
                this.recitationHistory.push(session);
                localStorage.setItem('quranRecitationHistory', JSON.stringify(this.recitationHistory));
                this.updateHistoryList();
            }

            updateHistoryList() {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                this.recitationHistory.slice().reverse().forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const dateStr = new Date(session.id).toLocaleString();
                    const durationStr = `${Math.floor(session.duration / 60)}m ${Math.floor(session.duration % 60)}s`;
                    item.innerHTML = `<div><strong>${dateStr}</strong></div>
                        <div>${this.quranDatabase[session.surah].name} ${session.verse}</div>
                        <div>${session.mistakes.length} mistakes • ${durationStr}</div>`;
                    item.addEventListener('click', () => {
                        alert(`Session Details\nDate: ${new Date(session.id).toLocaleString()}\nSurah: ${this.quranDatabase[session.surah].name}\nVerse: ${session.verse}\nMistakes: ${session.mistakes.length}\nDuration: ${Math.floor(session.duration / 60)}m ${Math.floor(session.duration % 60)}s`);
                    });
                    list.appendChild(item);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const quranSystem = new QuranRecitationSystem();
        });
    </script>
</body>
</html>
