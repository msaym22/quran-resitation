<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran AI - Recitation Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .status-display {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .status-idle {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-listening {
            background: #d4edda;
            color: #155724;
            animation: pulse 2s infinite;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recitation-display {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            font-size: 1.3em;
            line-height: 1.8;
            text-align: center;
            direction: rtl;
            font-family: 'Amiri', serif;
        }

        .current-word {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 4px;
            border: 2px solid #ffc107;
        }

        .mistake-word {
            background: #f8d7da;
            color: #721c24;
            padding: 2px 4px;
            border-radius: 4px;
            border: 2px solid #dc3545;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .mistake-log {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
        }

        .mistake-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .mistake-item:last-child {
            border-bottom: none;
        }

        .mistake-time {
            color: #666;
            font-size: 0.9em;
        }

        .mistake-text {
            color: #d63384;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .settings-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
            
            .title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üïå Quran AI Assistant</h1>
            <p class="subtitle">Advanced Recitation Analysis & Training System</p>
        </div>

        <div class="status-display status-idle" id="statusDisplay">
            Ready to begin recitation analysis
        </div>

        <div class="main-content">
            <div class="panel">
                <h3>üìñ Recitation Control</h3>
                
                <div class="control-group">
                    <label for="surahSelect">Select Surah:</label>
                    <select id="surahSelect">
                        <option value="">Choose a Surah...</option>
                        <option value="1">1. Al-Fatiha</option>
                        <option value="2">2. Al-Baqarah</option>
                        <option value="3">3. Al-Imran</option>
                        <option value="4">4. An-Nisa</option>
                        <option value="5">5. Al-Ma'idah</option>
                        <!-- Add more surahs as needed -->
                    </select>
                </div>

                <div class="control-group">
                    <label for="ayahRange">Ayah Range:</label>
                    <input type="text" id="ayahRange" placeholder="e.g., 1-7 or 1,3,5">
                </div>

                <div class="control-group">
                    <label for="startPosition">Start Position (optional):</label>
                    <input type="text" id="startPosition" placeholder="Auto-detect or specify word">
                </div>

                <div class="control-group">
                    <button class="btn btn-primary" id="startListening">üé§ Start Listening</button>
                    <button class="btn btn-secondary" id="pauseListening" disabled>‚è∏Ô∏è Pause</button>
                    <button class="btn btn-danger" id="stopListening" disabled>‚èπÔ∏è Stop</button>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="panel">
                <h3>‚öôÔ∏è AI Settings</h3>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="beepOnMistake" checked>
                    <label for="beepOnMistake">Beep sound on mistake</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="contextCorrection">
                    <label for="contextCorrection">Read 5-word context on mistake</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="pakistaniMode" checked>
                    <label for="pakistaniMode">Pakistani pronunciation mode</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="ignoreTajweed" checked>
                    <label for="ignoreTajweed">Ignore Tajweed mistakes</label>
                </div>

                <div class="control-group">
                    <label for="sensitivity">Mistake Detection Sensitivity:</label>
                    <input type="range" id="sensitivity" min="1" max="10" value="7">
                    <span id="sensitivityValue">7</span>
                </div>

                <div class="control-group">
                    <label>Upload Custom Reciter Voice:</label>
                    <div class="file-upload" id="voiceUpload">
                        <p>üìÅ Drag & drop audio file or click to select</p>
                        <input type="file" id="voiceFile" accept="audio/*" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>üìù Current Recitation</h3>
            <div class="recitation-display" id="recitationDisplay">
                <p style="color: #666;">Select a Surah and start listening to begin analysis...</p>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h3>‚ö†Ô∏è Mistake Log</h3>
                <div class="mistake-log" id="mistakeLog">
                    <p style="color: #666; text-align: center;">No mistakes detected yet</p>
                </div>
                <button class="btn btn-secondary" id="clearLog">Clear Log</button>
                <button class="btn btn-success" id="exportLog">Export History</button>
            </div>

            <div class="panel">
                <h3>üìä Session Statistics</h3>
                <div class="statistics">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">Words Recited</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMistakes">0</div>
                        <div class="stat-label">Mistakes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracy">100%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sessionTime">0:00</div>
                        <div class="stat-label">Session Time</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-panel">
            <h3>üîß Advanced Settings</h3>
            <div class="control-group">
                <button class="btn btn-primary" id="trainAI">üß† Train AI with Current Voice</button>
                <button class="btn btn-secondary" id="resetAI">üîÑ Reset AI Training</button>
                <button class="btn btn-success" id="loadDatabase">üì• Load Quran Database</button>
            </div>
        </div>
    </div>

    <script>
        class QuranAI {
            constructor() {
                this.isListening = false;
                this.recognition = null;
                this.currentSurah = null;
                this.currentAyah = 1;
                this.currentWordIndex = 0;
                this.quranDatabase = {};
                this.mistakes = [];
                this.sessionStats = {
                    totalWords: 0,
                    totalMistakes: 0,
                    startTime: null,
                    accuracy: 100
                };
                this.voiceTrainingData = [];
                this.pakistaniNormalizations = {
                    'ÿ≥': 'ÿ´',
                    'ÿµ': 'ÿ≥',
                    'ÿ≤': 'ÿ∞',
                    'ÿ∂': 'ÿ∏'
                };
                
                this.initializeComponents();
                this.loadQuranDatabase();
                this.setupEventListeners();
            }

            initializeComponents() {
                // Initialize Speech Recognition
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    this.recognition = new SpeechRecognition();
                } else {
                    alert('Speech recognition not supported in this browser.');
                    return;
                }

                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'ar-SA';
                this.recognition.maxAlternatives = 3;

                this.recognition.onstart = () => {
                    this.updateStatus('Listening...', 'listening');
                };

                this.recognition.onresult = (event) => {
                    this.processRecognitionResult(event);
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.updateStatus('Recognition error: ' + event.error, 'idle');
                };

                this.recognition.onend = () => {
                    if (this.isListening) {
                        this.recognition.start(); // Restart for continuous listening
                    }
                };
            }

            async loadQuranDatabase() {
                try {
                    // Try to load from GitHub first
                    const response = await fetch('https://raw.githubusercontent.com/hisaymizz/quran/main/quran-simple.txt');
                    if (response.ok) {
                        const text = await response.text();
                        this.parseQuranText(text);
                        this.updateStatus('Quran database loaded successfully', 'idle');
                    } else {
                        throw new Error('Failed to load from GitHub');
                    }
                } catch (error) {
                    console.error('Error loading Quran database:', error);
                    this.updateStatus('Failed to load database. Please upload manually.', 'idle');
                    this.showManualUploadOption();
                }
            }

            parseQuranText(text) {
                const lines = text.split('\n');
                let currentSurah = null;
                let currentAyah = 1;

                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('ÿ≥Ÿàÿ±ÿ©') || line.match(/^\d+\./)) {
                        // New Surah
                        const surahMatch = line.match(/(\d+)/);
                        if (surahMatch) {
                            currentSurah = parseInt(surahMatch[1]);
                            this.quranDatabase[currentSurah] = {};
                            currentAyah = 1;
                        }
                    } else if (line && currentSurah) {
                        // Process ayah
                        const words = this.tokenizeArabicText(line);
                        this.quranDatabase[currentSurah][currentAyah] = {
                            text: line,
                            words: words,
                            normalized: this.normalizeForPakistani(words)
                        };
                        currentAyah++;
                    }
                });
            }

            tokenizeArabicText(text) {
                // Remove diacritics and tokenize
                const cleanText = text.replace(/[\u064B-\u065F\u0670\u06DC\u06DF\u06E0\u06E2\u06E3\u06E5\u06E6\u06E8\u06EA\u06EB\u06EC\u06ED]/g, '');
                return cleanText.split(/\s+/).filter(word => word.length > 0);
            }

            normalizeForPakistani(words) {
                if (!document.getElementById('pakistaniMode').checked) {
                    return words;
                }

                return words.map(word => {
                    let normalized = word;
                    Object.keys(this.pakistaniNormalizations).forEach(original => {
                        const replacement = this.pakistaniNormalizations[original];
                        normalized = normalized.replace(new RegExp(original, 'g'), replacement);
                    });
                    return normalized;
                });
            }

            setupEventListeners() {
                // Control buttons
                document.getElementById('startListening').addEventListener('click', () => this.startListening());
                document.getElementById('pauseListening').addEventListener('click', () => this.pauseListening());
                document.getElementById('stopListening').addEventListener('click', () => this.stopListening());

                // Settings
                document.getElementById('sensitivity').addEventListener('input', (e) => {
                    document.getElementById('sensitivityValue').textContent = e.target.value;
                });

                // File upload
                document.getElementById('voiceUpload').addEventListener('click', () => {
                    document.getElementById('voiceFile').click();
                });

                document.getElementById('voiceFile').addEventListener('change', (e) => {
                    this.handleVoiceUpload(e.target.files[0]);
                });

                // Advanced functions
                document.getElementById('trainAI').addEventListener('click', () => this.trainAI());
                document.getElementById('resetAI').addEventListener('click', () => this.resetAI());
                document.getElementById('loadDatabase').addEventListener('click', () => this.loadQuranDatabase());
                document.getElementById('clearLog').addEventListener('click', () => this.clearMistakeLog());
                document.getElementById('exportLog').addEventListener('click', () => this.exportMistakeLog());

                // Drag and drop
                const uploadArea = document.getElementById('voiceUpload');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('audio/')) {
                        this.handleVoiceUpload(file);
                    }
                });
            }

            startListening() {
                const surahSelect = document.getElementById('surahSelect');
                if (!surahSelect.value) {
                    alert('Please select a Surah first.');
                    return;
                }

                this.currentSurah = parseInt(surahSelect.value);
                this.currentAyah = 1;
                this.currentWordIndex = 0;
                this.isListening = true;
                this.sessionStats.startTime = new Date();

                // Auto-detect start position if not specified
                this.detectStartPosition();

                this.updateControlButtons();
                this.displayCurrentAyah();
                this.recognition.start();
                this.updateSessionTimer();
            }

            pauseListening() {
                this.isListening = false;
                this.recognition.stop();
                this.updateStatus('Paused', 'idle');
                this.updateControlButtons();
            }

            stopListening() {
                this.isListening = false;
                this.recognition.stop();
                this.updateStatus('Stopped', 'idle');
                this.updateControlButtons();
                this.currentWordIndex = 0;
                this.updateProgress();
            }

            detectStartPosition() {
                // Auto-detect starting position based on initial audio
                const startPos = document.getElementById('startPosition').value;
                if (startPos) {
                    // Find the word position in the current ayah
                    const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                    if (ayahData) {
                        const wordIndex = ayahData.words.findIndex(word => word.includes(startPos));
                        if (wordIndex !== -1) {
                            this.currentWordIndex = wordIndex;
                        }
                    }
                }
            }

            processRecognitionResult(event) {
                if (!this.isListening) return;

                const result = event.results[event.results.length - 1];
                if (result.isFinal) {
                    const transcript = result[0].transcript.trim();
                    this.analyzeRecitation(transcript);
                }
            }

            analyzeRecitation(transcript) {
                this.updateStatus('Processing...', 'processing');
                
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) {
                    this.logMistake('Ayah not found in database', transcript, '');
                    return;
                }

                const spokenWords = this.tokenizeArabicText(transcript);
                const expectedWords = ayahData.normalized || ayahData.words;

                // Compare spoken words with expected words
                this.compareWords(spokenWords, expectedWords, ayahData.words);
                
                this.updateStatus('Listening...', 'listening');
            }

            compareWords(spokenWords, expectedWords, originalWords) {
                let mistakeFound = false;
                const sensitivity = parseInt(document.getElementById('sensitivity').value);

                for (let i = 0; i < spokenWords.length; i++) {
                    const spokenWord = spokenWords[i];
                    const expectedIndex = this.currentWordIndex + i;
                    
                    if (expectedIndex >= expectedWords.length) {
                        // Reciter is ahead or finished ayah
                        this.moveToNextAyah();
                        return;
                    }

                    const expectedWord = expectedWords[expectedIndex];
                    const similarity = this.calculateSimilarity(spokenWord, expectedWord);

                    if (similarity < (sensitivity / 10)) {
                        mistakeFound = true;
                        this.handleMistake(spokenWord, originalWords[expectedIndex], expectedIndex);
                    } else {
                        this.sessionStats.totalWords++;
                        this.highlightCurrentWord(expectedIndex);
                    }
                }

                if (!mistakeFound) {
                    this.currentWordIndex += spokenWords.length;
                    this.updateProgress();
                }

                this.updateStatistics();
            }

            calculateSimilarity(word1, word2) {
                // Simple similarity calculation - can be enhanced
                if (word1 === word2) return 1.0;
                
                // Levenshtein distance calculation
                const matrix = Array(word2.length + 1).fill().map(() => Array(word1.length + 1).fill(0));
                
                for (let i = 0; i <= word1.length; i++) matrix[0][i] = i;
                for (let j = 0; j <= word2.length; j++) matrix[j][0] = j;
                
                for (let j = 1; j <= word2.length; j++) {
                    for (let i = 1; i <= word1.length; i++) {
                        if (word1[i - 1] === word2[j - 1]) {
                            matrix[j][i] = matrix[j - 1][i - 1];
                        } else {
                            matrix[j][i] = Math.min(
                                matrix[j - 1][i] + 1,
                                matrix[j][i - 1] + 1,
                                matrix[j - 1][i - 1] + 1
                            );
                        }
                    }
                }
                
                const maxLength = Math.max(word1.length, word2.length);
                return 1 - (matrix[word2.length][word1.length] / maxLength);
            }

            handleMistake(spokenWord, expectedWord, wordIndex) {
                this.sessionStats.totalMistakes++;
                
                // Log the mistake
                this.logMistake('Word mismatch', spokenWord, expectedWord);
                
                // Visual feedback
                this.highlightMistake(wordIndex);
                
                // Audio feedback
                if (document.getElementById('beepOnMistake').checked) {
                    this.playBeep();
                }
                
                // Context correction
                if (document.getElementById('contextCorrection').checked) {
                    this.playContextCorrection(wordIndex);
                }
            }

            logMistake(type, spoken, expected) {
                const mistake = {
                    type: type,
                    spoken: spoken,
                    expected: expected,
                    timestamp: new Date(),
                    surah: this.currentSurah,
                    ayah: this.currentAyah,
                    wordIndex: this.currentWordIndex
                };
                
                this.mistakes.push(mistake);
                this.updateMistakeLog();
            }

            updateMistakeLog() {
                const logContainer = document.getElementById('mistakeLog');
                
                if (this.mistakes.length === 0) {
                    logContainer.innerHTML = '<p style="color: #666; text-align: center;">No mistakes detected yet</p>';
                    return;
                }
                
                logContainer.innerHTML = this.mistakes.map(mistake => `
                    <div class="mistake-item">
                        <div class="mistake-time">${mistake.timestamp.toLocaleTimeString()}</div>
                        <div class="mistake-text">
                            <strong>${mistake.type}</strong><br>
                            Spoken: "${mistake.spoken}" ‚Üí Expected: "${mistake.expected}"<br>
                            <small>Surah ${mistake.surah}, Ayah ${mistake.ayah}</small>
                        </div>
                    </div>
                `).reverse().join('');
            }

            playBeep() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            }

            playContextCorrection(wordIndex) {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) return;
                
                const startIndex = Math.max(0, wordIndex - 2);
                const endIndex = Math.min(ayahData.words.length, wordIndex + 3);
                const contextWords = ayahData.words.slice(startIndex, endIndex);
                
                // Highlight the correction context
                this.highlightContext(startIndex, endIndex, wordIndex);
                
                // Use speech synthesis to read the context
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(contextWords.join(' '));
                    utterance.lang = 'ar-SA';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }

            highlightCurrentWord(wordIndex) {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) return;
                
                const displayDiv = document.getElementById('recitationDisplay');
                const words = ayahData.words;
                
                const highlightedText = words.map((word, index) => {
                    if (index === wordIndex) {
                        return `<span class="current-word">${word}</span>`;
                    }
                    return word;
                }).join(' ');
                
                displayDiv.innerHTML = highlightedText;
            }

            highlightMistake(wordIndex) {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) return;
                
                const displayDiv = document.getElementById('recitationDisplay');
                const words = ayahData.words;
                
                const highlightedText = words.map((word, index) => {
                    if (index === wordIndex) {
                        return `<span class="mistake-word">${word}</span>`;
                    } else if (index === this.currentWordIndex) {
                        return `<span class="current-word">${word}</span>`;
                    }
                    return word;
                }).join(' ');
                
                displayDiv.innerHTML = highlightedText;
            }

            highlightContext(startIndex, endIndex, mistakeIndex) {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) return;
                
                const displayDiv = document.getElementById('recitationDisplay');
                const words = ayahData.words;
                
                const highlightedText = words.map((word, index) => {
                    if (index === mistakeIndex) {
                        return `<span class="mistake-word">${word}</span>`;
                    } else if (index >= startIndex && index < endIndex) {
                        return `<span style="background: #fff3cd; padding: 2px;">${word}</span>`;
                    }
                    return word;
                }).join(' ');
                
                displayDiv.innerHTML = highlightedText;
            }

            displayCurrentAyah() {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) {
                    document.getElementById('recitationDisplay').innerHTML = '<p style="color: #red;">Ayah not found in database</p>';
                    return;
                }
                
                document.getElementById('recitationDisplay').innerHTML = ayahData.text;
            }

            moveToNextAyah() {
                this.currentAyah++;
                this.currentWordIndex = 0;
                
                if (this.quranDatabase[this.currentSurah]?.[this.currentAyah]) {
                    this.displayCurrentAyah();
                    this.updateProgress();
                } else {
                    // End of surah
                    this.stopListening();
                    this.updateStatus('Surah completed!', 'idle');
                    alert('Congratulations! You have completed the Surah.');
                }
            }

            updateProgress() {
                const ayahData = this.quranDatabase[this.currentSurah]?.[this.currentAyah];
                if (!ayahData) return;
                
                const progress = (this.currentWordIndex / ayahData.words.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }

            updateStatistics() {
                document.getElementById('totalWords').textContent = this.sessionStats.totalWords;
                document.getElementById('totalMistakes').textContent = this.sessionStats.totalMistakes;
                
                const accuracy = this.sessionStats.totalWords > 0 ? 
                    ((this.sessionStats.totalWords - this.sessionStats.totalMistakes) / this.sessionStats.totalWords * 100).toFixed(1) : 100;
                document.getElementById('accuracy').textContent = accuracy + '%';
            }

            updateSessionTimer() {
                if (!this.sessionStats.startTime) return;
                
                const updateTimer = () => {
                    if (this.isListening && this.sessionStats.startTime) {
                        const elapsed = new Date() - this.sessionStats.startTime;
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        document.getElementById('sessionTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                };
                
                updateTimer();
                setInterval(updateTimer, 1000);
            }

            updateStatus(message, type) {
                const statusDiv = document.getElementById('statusDisplay');
                statusDiv.textContent = message;
                statusDiv.className = `status-display status-${type}`;
            }

            updateControlButtons() {
                const startBtn = document.getElementById('startListening');
                const pauseBtn = document.getElementById('pauseListening');
                const stopBtn = document.getElementById('stopListening');
                
                if (this.isListening) {
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    pauseBtn.disabled = true;
                    stopBtn.disabled = true;
                }
            }

            handleVoiceUpload(file) {
                if (!file) return;
                
                const formData = new FormData();
                formData.append('voice', file);
                
                // Process the uploaded voice file for training
                const reader = new FileReader();
                reader.onload = (e) => {
                    const audioData = e.target.result;
                    this.voiceTrainingData.push({
                        filename: file.name,
                        data: audioData,
                        timestamp: new Date()
                    });
                    
                    document.getElementById('voiceUpload').innerHTML = `
                        <p>‚úÖ Voice file uploaded: ${file.name}</p>
                        <p>Ready for training</p>
                    `;
                };
                reader.readAsArrayBuffer(file);
            }

            trainAI() {
                if (this.voiceTrainingData.length === 0) {
                    alert('Please upload a voice file first.');
                    return;
                }
                
                this.updateStatus('Training AI with your voice...', 'processing');
                
                // Simulate AI training process
                setTimeout(() => {
                    // In a real implementation, this would process the audio data
                    // and adjust the recognition parameters
                    
                    // Update recognition settings based on training
                    this.recognition.lang = 'ar-SA';
                    
                    // Store training data for future use
                    const trainingProfile = {
                        voiceData: this.voiceTrainingData,
                        pakistaniMode: document.getElementById('pakistaniMode').checked,
                        sensitivity: document.getElementById('sensitivity').value,
                        timestamp: new Date()
                    };
                    
                    // Save to memory (in real app, would save to server)
                    this.currentVoiceProfile = trainingProfile;
                    
                    this.updateStatus('AI training completed!', 'idle');
                    alert('AI has been trained with your voice. Recognition accuracy should improve.');
                }, 3000);
            }

            resetAI() {
                this.voiceTrainingData = [];
                this.currentVoiceProfile = null;
                this.recognition.lang = 'ar-SA';
                
                document.getElementById('voiceUpload').innerHTML = `
                    <p>üìÅ Drag & drop audio file or click to select</p>
                `;
                
                this.updateStatus('AI training reset', 'idle');
                alert('AI training has been reset to default settings.');
            }

            clearMistakeLog() {
                this.mistakes = [];
                this.updateMistakeLog();
            }

            exportMistakeLog() {
                if (this.mistakes.length === 0) {
                    alert('No mistakes to export.');
                    return;
                }
                
                const exportData = {
                    session: {
                        date: new Date().toISOString(),
                        surah: this.currentSurah,
                        statistics: this.sessionStats
                    },
                    mistakes: this.mistakes
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `quran-mistakes-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            showManualUploadOption() {
                const manualUpload = document.createElement('div');
                manualUpload.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h4>‚ö†Ô∏è Manual Database Upload Required</h4>
                        <p>Please upload the Quran database file manually:</p>
                        <input type="file" id="manualDbUpload" accept=".txt,.json">
                        <button onclick="quranAI.handleManualDbUpload()" class="btn btn-primary">Upload Database</button>
                    </div>
                `;
                
                document.querySelector('.container').insertBefore(manualUpload, document.querySelector('.main-content'));
            }

            handleManualDbUpload() {
                const fileInput = document.getElementById('manualDbUpload');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file first.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    this.parseQuranText(content);
                    this.updateStatus('Database uploaded successfully!', 'idle');
                    
                    // Remove manual upload section
                    const uploadSection = document.getElementById('manualDbUpload').closest('div');
                    uploadSection.remove();
                };
                reader.readAsText(file);
            }

            // Advanced features for Pakistani users
            setupPakistaniOptimizations() {
                // Add common Pakistani pronunciation patterns
                this.pakistaniPatterns = {
                    // Common substitutions in Pakistani recitation
                    'ÿ´': ['ÿ≥', 'ÿ™'],
                    'ÿ∞': ['ÿ≤', 'ÿØ'],
                    'ÿ∂': ['ÿ≤', 'ÿØ'],
                    'ÿ∏': ['ÿ≤', 'ÿ∑'],
                    'ÿπ': ['ÿß', 'ÿ°'],
                    'ÿ∫': ['ŸÇ', 'ÿÆ']
                };
                
                // Adjust sensitivity for Pakistani pronunciations
                if (document.getElementById('pakistaniMode').checked) {
                    this.recognition.lang = 'ar-SA'; // Keep Arabic but with adjusted processing
                }
            }

            // Enhanced mistake detection for Pakistani users
            enhancedMistakeDetection(spoken, expected) {
                if (!document.getElementById('pakistaniMode').checked) {
                    return this.calculateSimilarity(spoken, expected);
                }
                
                // Apply Pakistani-specific normalization
                let normalizedSpoken = spoken;
                let normalizedExpected = expected;
                
                Object.keys(this.pakistaniPatterns).forEach(original => {
                    const alternatives = this.pakistaniPatterns[original];
                    alternatives.forEach(alt => {
                        normalizedSpoken = normalizedSpoken.replace(new RegExp(original, 'g'), alt);
                        normalizedExpected = normalizedExpected.replace(new RegExp(original, 'g'), alt);
                    });
                });
                
                return this.calculateSimilarity(normalizedSpoken, normalizedExpected);
            }
        }

        // Initialize the Quran AI system
        let quranAI;
        
        document.addEventListener('DOMContentLoaded', () => {
            quranAI = new QuranAI();
            
            // Add some sample Quran data for testing
            quranAI.quranDatabase = {
                1: {
                    1: {
                        text: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê",
                        words: ["ÿ®Ÿêÿ≥ŸíŸÖŸê", "ÿßŸÑŸÑŸéŸëŸáŸê", "ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê", "ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê"],
                        normalized: ["ÿ®ÿ≥ŸÖ", "ÿßŸÑŸÑŸá", "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", "ÿßŸÑÿ±ÿ≠ŸäŸÖ"]
                    },
                    2: {
                        text: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé",
                        words: ["ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè", "ŸÑŸêŸÑŸéŸëŸáŸê", "ÿ±Ÿéÿ®ŸêŸë", "ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé"],
                        normalized: ["ÿßŸÑÿ≠ŸÖÿØ", "ŸÑŸÑŸá", "ÿ±ÿ®", "ÿßŸÑÿπÿßŸÑŸÖŸäŸÜ"]
                    }
                }
            };
        });

        // Global functions for UI interactions
        window.quranAI = quranAI;
    </script>
</body>
</html>
